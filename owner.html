<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags and Title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard - Smart Kiosk</title>

    <!-- Bootstrap CSS CDN -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />

    <!-- Optional Bootstrap JavaScript and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
    ></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- Custom Styles -->
    <style>
        /* Import Custom Font */
        @import url('https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap');

        /* CSS Variables for Light Theme */
        :root {
            --bg-color: #f4f4f9;
            --text-color: #333;
            --sidebar-bg: #ffffff;
            --sidebar-text: #333;
            --button-bg: #28a745; /* Darker green for better contrast */
            --button-hover-bg: #218838; /* Even darker green on hover */
            --card-bg: #ffffff;
            --input-bg: #fff;
            --input-text: #333;
            --overlay: rgba(0, 0, 0, 0.05);
            --danger-bg: #dc3545; /* Bootstrap's danger color */
            --warning-bg: #ffc107; /* Bootstrap's warning color */
            --info-bg: #17a2b8; /* Bootstrap's info color */
        }

        /* Base Styles */
        body {
            font-family: "Raleway", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Sidebar Styles */
        .sidebar {
            min-width: 250px;
            max-width: 250px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 0px 10px;
            position: relative;
            z-index: 2;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 1.5rem;
            margin-bottom: 30px;
            animation: fadeIn 1.5s ease-in-out;
        }

        .sidebar .nav-link {
            color: var(--sidebar-text);
            font-size: 1.1rem;
            margin-bottom: 10px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .sidebar .nav-link.active {
            background-color: var(--button-bg);
            color: #fff;
            border-radius: 5px;
        }

        .sidebar .nav-link:hover {
            background-color: var(--overlay);
            border-radius: 5px;
        }

        /* Content Styles */
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        /* Header Styles */
        .content h1 {
            font-size: 2rem;
            margin-bottom: 20px;
            animation: fadeInUp 1.5s ease-in-out;
        }

        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            border: none;
            border-radius: 10px;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px;
            padding: 20px;
            margin-bottom: 20px;
            animation: slideUp 0.7s ease-in-out;
        }

        /* Table Styles */
        table {
            width: 100%;
            margin-bottom: 20px;
        }

        th, td {
            text-align: left;
            padding: 12px;
        }

        th {
            background-color: #f8f9fa;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        /* Button Styles */
        .btn-custom {
            background-color: var(--button-bg);
            color: #fff;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .btn-custom:hover {
            background-color: var(--button-hover-bg);
        }

        /* Modal Styles */
        .modal-content {
            border-radius: 10px;
        }

        /* Rotating Food Icons */
        .food-icon {
            position: absolute;
            font-size: 50px;
            opacity: 0.3;
            animation: rotate 40s linear infinite;
            z-index: 0; /* Behind main content */
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg) translateX(150px) rotate(0deg);
            }
            to {
                transform: rotate(360deg) translateX(150px) rotate(-360deg);
            }
        }

        /* Positioning Food Icons */
        .food-icon-1 {
            top: 10%;
            left: 15%;
        }

        .food-icon-2 {
            top: 30%;
            left: 35%;
            animation-duration: 50s;
        }

        .food-icon-3 {
            top: 50%;
            left: 55%;
            animation-duration: 30s;
        }

        .food-icon-4 {
            top: 20%;
            left: 75%;
            animation-duration: 40s;
        }

        .food-icon-5 {
            top: 40%;
            left: 95%;
            animation-duration: 35s;
        }

        /* Text Animations */
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            0% {
                transform: translateY(50px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                min-width: 200px;
                max-width: 200px;
            }

            .food-icon {
                font-size: 40px;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                display: none;
            }

            .content {
                padding: 10px;
            }

            .food-icon {
                font-size: 30px;
            }

            .content h1 {
                font-size: 1.5rem;
            }
        }

        /* Badge Styles for Order Status */
        .badge-success {
            background-color: #28a745;
            color: #fff;
        }

        .badge-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .badge-danger {
            background-color: #dc3545;
            color: #fff;
        }

        .badge-info {
            background-color: #17a2b8;
            color: #fff;
        }
    </style>
</head>
<body>

    <!-- Rotating Food Icons -->
    <span class="food-icon food-icon-1">üçï</span>
    <span class="food-icon food-icon-2">üçî</span>
    <span class="food-icon food-icon-3">üç£</span>
    <span class="food-icon food-icon-4">üçü</span>
    <span class="food-icon food-icon-5">üåÆ</span>

    <!-- Sidebar -->
    <div class="sidebar">
        <h3>Owner Dashboard</h3>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#" id="nav-dashboard">Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="nav-menu">Menu</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="nav-categories">Categories</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="nav-orders">Orders</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="nav-sales">Sales</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-custom mt-3 text-center" href="owner_login.html">Logout</a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="content">
        <h4 class="animated-text">Welcome to Your Dashboard, <span id="owner-username">Owner</span></h4>
        <div id="content-area">
            <!-- Dynamic Content Will Be Loaded Here -->
        </div>
    </div>

    <!-- Modals -->
    <!-- Add/Edit Menu Item Modal -->
    <div class="modal fade" id="menuModal" tabindex="-1" role="dialog" aria-labelledby="menuModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="menuModalLabel">Add/Edit Menu Item</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeMenuModal()">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form id="menuForm">
              <div class="modal-body">
                  <input type="hidden" id="menuKey">
                  <div class="form-group">
                      <label for="menuName">Name</label>
                      <input type="text" class="form-control" id="menuName" required>
                  </div>
                  <div class="form-group">
                      <label for="menuDescription">Description</label>
                      <textarea class="form-control" id="menuDescription" required></textarea>
                  </div>
                  <div class="form-group">
                      <label for="menuPrice">Price ($)</label>
                      <input type="number" step="0.01" class="form-control" id="menuPrice" required>
                  </div>
                  <div class="form-group">
                      <label for="menuCategory">Category</label>
                      <select class="form-control" id="menuCategory" required>
                          <option value="" disabled selected>Select Category</option>
                          <!-- Categories will be populated here -->
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="menuFranchise">Franchise</label>
                      <select class="form-control" id="menuFranchise" disabled>
                          <!-- Franchise will be selected based on owner -->
                      </select>
                  </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closeMenuModal()">Cancel</button>
                <button type="submit" class="btn btn-custom">Save</button>
              </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Add/Edit Category Modal -->
    <div class="modal fade" id="categoryModal" tabindex="-1" role="dialog" aria-labelledby="categoryModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="categoryModalLabel">Add/Edit Category</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeCategoryModal()">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form id="categoryForm">
              <div class="modal-body">
                  <input type="hidden" id="categoryKey">
                  <div class="form-group">
                      <label for="categoryName">Name</label>
                      <input type="text" class="form-control" id="categoryName" required>
                  </div>
                  <div class="form-group">
                      <label for="categoryFranchise">Franchise</label>
                      <select class="form-control" id="categoryFranchise" disabled>
                          <!-- Franchise will be selected based on owner -->
                      </select>
                  </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closeCategoryModal()">Cancel</button>
                <button type="submit" class="btn btn-custom">Save</button>
              </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Firebase and App Scripts -->
    <script>
  
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDg2mw8IYPFTsFJGKspl2gH0aWSq4pFh_U",
            authDomain: "kioskse-4dda0.firebaseapp.com",
            projectId: "kioskse-4dda0",
            storageBucket: "kioskse-4dda0.appspot.com",
            messagingSenderId: "848116488429",
            appId: "1:848116488429:web:2b21525e5610a23f7c14e4",
            measurementId: "G-LL7RKF5E9T",
            databaseURL: "https://kioskse-4dda0-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Parse ownerId from URL
        function getOwnerId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('ownerId');
        }

        const ownerId = getOwnerId();

        if (!ownerId) {
            alert('No ownerId found. Redirecting to login page.');
            window.location.href = 'owner_login.html';
        }

        // Fetch owner details
        let ownerName = "Owner";

        function fetchOwnerDetails() {
            return db.ref(`owners/${ownerId}`).once('value').then(snapshot => {
                const owner = snapshot.val();
                if (owner) {
                    ownerName = owner.name;
                    document.getElementById('owner-username').innerText = ownerName;
                } else {
                    alert('Owner not found. Redirecting to login page.');
                    window.location.href = 'owner_login.html';
                }
            }).catch(error => {
                console.error(error);
                alert('Error fetching owner details.');
                window.location.href = 'owner_login.html';
            });
        }

        // Fetch franchise(s) for the owner
        let franchises = [];

        function fetchFranchises() {
            return db.ref('franchises').once('value').then(snapshot => {
                const data = snapshot.val();
                franchises = [];

                for (const key in data) {
                    const franchise = data[key];
                    if (franchise && String(franchise.ownerId) === String(ownerId)) {
                        franchises.push(franchise);
                    }
                }

                if (franchises.length === 0) {
                    alert('No franchises found for this owner.');
                }
            }).catch(error => {
                console.error(error);
                alert('Error fetching franchises.');
            });
        }

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchOwnerDetails();
            await fetchFranchises();
            if (franchises.length > 0) {
                loadDashboard();
                setupNavigation();
            }
        });

        // Setup Navigation Links
        function setupNavigation() {
            document.getElementById('nav-dashboard').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveNav('nav-dashboard');
                loadDashboard();
            });

            document.getElementById('nav-menu').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveNav('nav-menu');
                loadMenu();
            });

            document.getElementById('nav-categories').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveNav('nav-categories');
                loadCategories();
            });

            document.getElementById('nav-orders').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveNav('nav-orders');
                loadOrders();
            });

            document.getElementById('nav-sales').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveNav('nav-sales');
                loadSales();
            });
        }

        // Set Active Navigation
        function setActiveNav(navId) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.getElementById(navId).classList.add('active');
        }

        // Load Dashboard
        function loadDashboard() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="card">
                            <h5>Total Sales</h5>
                            <p id="total-sales">$0.00</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <h5>Completed Orders</h5>
                            <p id="completed-orders">0</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <h5>In Progress Orders</h5>
                            <p id="inprogress-orders">0</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <h5>Cancelled Orders</h5>
                            <p id="cancelled-orders">0</p>
                        </div>
                    </div>
                </div>
            `;

            // Fetch and display dashboard data
            let totalSales = 0;
            let completedOrders = 0;
            let inProgressOrders = 0;
            let cancelledOrders = 0;

            const salesPromises = franchises.map(franchise => {
                return db.ref('sales').once('value').then(snapshot => {
                    const sales = snapshot.val() || {};
                    for (const saleKey in sales) {
                        const sale = sales[saleKey];
                        if (sale && String(sale.franchiseId) === String(franchise.franchiseId)) {
                            totalSales += parseFloat(sale.amount);
                        }
                    }
                });
            });

            const ordersPromises = franchises.map(franchise => {
                return db.ref('orders').once('value').then(snapshot => {
                    const orders = snapshot.val() || {};
                    for (const orderKey in orders) {
                        const order = orders[orderKey];
                        if (order && String(order.franchiseId) === String(franchise.franchiseId)) {
                            if (order.status === 'Completed') {
                                completedOrders += 1;
                            } else if (order.status === 'In Progress') {
                                inProgressOrders += 1;
                            } else if (order.status === 'Cancelled') {
                                cancelledOrders += 1;
                            }
                        }
                    }
                });
            });

            Promise.all([...salesPromises, ...ordersPromises]).then(() => {
                document.getElementById('total-sales').innerText = `$${totalSales.toFixed(2)}`;
                document.getElementById('completed-orders').innerText = completedOrders;
                document.getElementById('inprogress-orders').innerText = inProgressOrders;
                document.getElementById('cancelled-orders').innerText = cancelledOrders;
            }).catch(error => {
                console.error(error);
                alert('Error fetching dashboard data.');
            });
        }

        // Load Menu
        function loadMenu() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Menu</h2>
                    <button class="btn btn-custom" onclick="openMenuModal()">Add Menu Item</button>
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Price ($)</th>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="menu-table-body">
                        <!-- Menu Items Will Be Loaded Here -->
                    </tbody>
                </table>
            `;

            // Fetch and display menu items
            db.ref('menu').once('value').then(snapshot => {
                const menuData = snapshot.val() || {};
                const tableBody = document.getElementById('menu-table-body');
                tableBody.innerHTML = ''; // Clear existing data to prevent duplication

                const categoryPromises = [];

                for (const key in menuData) {
                    const item = menuData[key];
                    if (item && franchises.some(franchise => String(franchise.franchiseId) === String(item.franchiseId))) {
                        // Fetch category name
                        const categoryKey = item.categoryId;
                        const categoryPromise = db.ref(`categories/${categoryKey}`).once('value').then(catSnapshot => {
                            const category = catSnapshot.val();
                            const categoryName = category ? category.name : 'Uncategorized';

                            const row = `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.description}</td>
                                    <td>${parseFloat(item.price).toFixed(2)}</td>
                                    <td>${categoryName}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm" onclick="editMenuItem('${key}')">Edit</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteMenuItem('${key}')">Delete</button>
                                    </td>
                                </tr>
                            `;
                            tableBody.insertAdjacentHTML('beforeend', row);
                        }).catch(error => {
                            console.error(error);
                            alert('Error fetching category details.');
                        });
                        categoryPromises.push(categoryPromise);
                    }
                }

                // Wait for all category names to be fetched
                Promise.all(categoryPromises).catch(error => {
                    console.error(error);
                    alert('Error loading menu items.');
                });

            }).catch(error => {
                console.error(error);
                alert('Error fetching menu items.');
            });
        }

        // Open Menu Modal for Adding
        function openMenuModal() {
            // Reset form
            document.getElementById('menuForm').reset();
            document.getElementById('menuKey').value = '';
            populateMenuCategories();
            populateMenuFranchise();
            $('#menuModal').modal('show');
        }

        // Close Menu Modal
        function closeMenuModal() {
            $('#menuModal').modal('hide');
        }

        // Populate Categories in Menu Modal
        function populateMenuCategories() {
            return db.ref('categories').once('value').then(snapshot => {
                const categories = snapshot.val() || {};
                const categorySelect = document.getElementById('menuCategory');
                categorySelect.innerHTML = '<option value="" disabled selected>Select Category</option>';

                for (const key in categories) {
                    const category = categories[key];
                    // Only categories related to owner's franchise
                    franchises.forEach(franchise => {
                        if (String(category.franchiseId) === String(franchise.franchiseId)) {
                            const option = `<option value="${key}">${category.name}</option>`;
                            categorySelect.insertAdjacentHTML('beforeend', option);
                        }
                    });
                }
            }).catch(error => {
                console.error(error);
                alert('Error fetching categories.');
            });
        }

        // Populate Franchise in Menu Modal (disabled as owner has specific franchises)
        function populateMenuFranchise() {
            const franchiseSelect = document.getElementById('menuFranchise');
            franchiseSelect.innerHTML = '';

            franchises.forEach(franchise => {
                const option = `<option value="${franchise.franchiseId}">${franchise.name}</option>`;
                franchiseSelect.insertAdjacentHTML('beforeend', option);
            });
        }

        // Handle Menu Form Submission
        document.getElementById('menuForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const menuKey = document.getElementById('menuKey').value;
            const name = document.getElementById('menuName').value.trim();
            const description = document.getElementById('menuDescription').value.trim();
            const price = parseFloat(document.getElementById('menuPrice').value).toFixed(2);
            const categoryId = document.getElementById('menuCategory').value;
            const franchiseId = document.getElementById('menuFranchise').value;

            if (!name || !description || isNaN(price) || !categoryId || !franchiseId) {
                alert('Please fill in all fields correctly.');
                return;
            }

            const menuRef = db.ref('menu');

            if (menuKey) {
                // Update existing menu item
                menuRef.child(menuKey).update({
                    name,
                    description,
                    price,
                    categoryId,
                    franchiseId
                }).then(() => {
                    closeMenuModal();
                    alert('Menu item updated successfully.');
                    loadMenu();
                }).catch(error => {
                    console.error(error);
                    alert('Error updating menu item.');
                });
            } else {
                // Add new menu item
                menuRef.push({
                    name,
                    description,
                    price,
                    categoryId,
                    franchiseId
                }).then(() => {
                    closeMenuModal();
                    alert('Menu item added successfully.');
                    loadMenu();
                }).catch(error => {
                    console.error(error);
                    alert('Error adding menu item.');
                });
            }
        });

        // Edit Menu Item
        function editMenuItem(key) {
            db.ref('menu').child(key).once('value').then(snapshot => {
                const item = snapshot.val();

                if (item) {
                    document.getElementById('menuKey').value = key;
                    document.getElementById('menuName').value = item.name;
                    document.getElementById('menuDescription').value = item.description;
                    document.getElementById('menuPrice').value = parseFloat(item.price).toFixed(2);
                    populateMenuCategories().then(() => {
                        document.getElementById('menuCategory').value = item.categoryId;
                        populateMenuFranchise();
                        document.getElementById('menuFranchise').value = item.franchiseId;
                        $('#menuModal').modal('show');
                    });
                } else {
                    alert('Menu item not found.');
                }
            }).catch(error => {
                console.error(error);
                alert('Error fetching menu item.');
            });
        }

        // Delete Menu Item
        function deleteMenuItem(key) {
            if (confirm('Are you sure you want to delete this menu item?')) {
                db.ref('menu').child(key).remove().then(() => {
                    alert('Menu item deleted successfully.');
                    loadMenu();
                }).catch(error => {
                    console.error(error);
                    alert('Error deleting menu item.');
                });
            }
        }

        // Load Categories
        function loadCategories() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Categories</h2>
                    <button class="btn btn-custom" onclick="openCategoryModal()">Add Category</button>
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Franchise</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="category-table-body">
                        <!-- Categories Will Be Loaded Here -->
                    </tbody>
                </table>
            `;

            // Fetch and display categories
            db.ref('categories').once('value').then(snapshot => {
                const categories = snapshot.val() || {};
                const tableBody = document.getElementById('category-table-body');
                tableBody.innerHTML = ''; // Clear existing data

                for (const key in categories) {
                    const category = categories[key];
                    // Only categories related to owner's franchise
                    franchises.forEach(franchise => {
                        if (String(category.franchiseId) === String(franchise.franchiseId)) {
                            const row = `
                                <tr>
                                    <td>${category.name}</td>
                                    <td>${franchise.name}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm" onclick="editCategory('${key}')">Edit</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteCategory('${key}')">Delete</button>
                                    </td>
                                </tr>
                            `;
                            tableBody.insertAdjacentHTML('beforeend', row);
                        }
                    });
                }
            }).catch(error => {
                console.error(error);
                alert('Error fetching categories.');
            });
        }

        // Open Category Modal for Adding
        function openCategoryModal() {
            // Reset form
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryKey').value = '';
            populateCategoryFranchise();
            $('#categoryModal').modal('show');
        }

        // Close Category Modal
        function closeCategoryModal() {
            $('#categoryModal').modal('hide');
        }

        // Populate Franchise in Category Modal (disabled as owner has specific franchises)
        function populateCategoryFranchise() {
            const franchiseSelect = document.getElementById('categoryFranchise');
            franchiseSelect.innerHTML = '';

            franchises.forEach(franchise => {
                const option = `<option value="${franchise.franchiseId}">${franchise.name}</option>`;
                franchiseSelect.insertAdjacentHTML('beforeend', option);
            });
        }

        // Handle Category Form Submission
        document.getElementById('categoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const categoryKey = document.getElementById('categoryKey').value;
            const name = document.getElementById('categoryName').value.trim();
            const franchiseId = document.getElementById('categoryFranchise').value;

            if (!name || !franchiseId) {
                alert('Please fill in all fields correctly.');
                return;
            }

            const categoriesRef = db.ref('categories');

            if (categoryKey) {
                // Update existing category
                categoriesRef.child(categoryKey).update({
                    name,
                    franchiseId
                }).then(() => {
                    closeCategoryModal();
                    alert('Category updated successfully.');
                    loadCategories();
                }).catch(error => {
                    console.error(error);
                    alert('Error updating category.');
                });
            } else {
                // Add new category
                categoriesRef.push({
                    name,
                    franchiseId
                }).then(() => {
                    closeCategoryModal();
                    alert('Category added successfully.');
                    loadCategories();
                }).catch(error => {
                    console.error(error);
                    alert('Error adding category.');
                });
            }
        });

        // Edit Category
        function editCategory(key) {
            db.ref('categories').child(key).once('value').then(snapshot => {
                const category = snapshot.val();

                if (category) {
                    document.getElementById('categoryKey').value = key;
                    document.getElementById('categoryName').value = category.name;
                    populateCategoryFranchise();
                    document.getElementById('categoryFranchise').value = category.franchiseId;
                    $('#categoryModal').modal('show');
                } else {
                    alert('Category not found.');
                }
            }).catch(error => {
                console.error(error);
                alert('Error fetching category.');
            });
        }

        // Delete Category
        function deleteCategory(key) {
            if (confirm('Are you sure you want to delete this category?')) {
                db.ref('categories').child(key).remove().then(() => {
                    alert('Category deleted successfully.');
                    loadCategories();
                }).catch(error => {
                    console.error(error);
                    alert('Error deleting category.');
                });
            }
        }

        // Load Orders
        function loadOrders() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <h2>Orders</h2>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Items</th>
                            <th>Total ($)</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body">
                        <!-- Orders Will Be Loaded Here -->
                    </tbody>
                </table>
            `;

            // Fetch and display orders
            db.ref('orders').once('value').then(snapshot => {
                const orders = snapshot.val() || {};
                const tableBody = document.getElementById('orders-table-body');
                tableBody.innerHTML = ''; // Clear existing data

                for (const key in orders) {
                    const order = orders[key];
                    if (order && franchises.some(franchise => String(franchise.franchiseId) === String(order.franchiseId))) {
                        // Fetch customer name
                        const customerId = order.customerUserId;
                        db.ref(`users/${customerId}`).once('value').then(userSnapshot => {
                            const user = userSnapshot.val();
                            const customerName = user ? user.userName : order.customer;

                            // Prepare items list
                            let itemsList = '';
                            for (const itemName in order.items) {
                                const item = order.items[itemName];
                                itemsList += `${itemName} (${item.quantity}), `;
                            }
                            itemsList = itemsList.slice(0, -2); // Remove trailing comma and space

                            const statusOptions = ['Completed', 'In Progress', 'Cancelled', 'Dropped'];
                            let statusSelect = `<select class="form-control form-control-sm" onchange="updateOrderStatus('${key}', this.value)">`;
                            statusOptions.forEach(status => {
                                statusSelect += `<option value="${status}" ${order.status === status ? 'selected' : ''}>${status}</option>`;
                            });
                            statusSelect += '</select>';

                            const row = `
                                <tr>
                                    <td>${order.orderId}</td>
                                    <td>${customerName}</td>
                                    <td>${itemsList}</td>
                                    <td>${parseFloat(order.total).toFixed(2)}</td>
                                    <td>
                                        ${statusSelect}
                                    </td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" onclick="deleteOrder('${key}')">Delete</button>
                                    </td>
                                </tr>
                            `;
                            tableBody.insertAdjacentHTML('beforeend', row);
                        }).catch(error => {
                            console.error(error);
                            alert('Error fetching customer details.');
                        });
                    }
                }
            }).catch(error => {
                console.error(error);
                alert('Error fetching orders.');
            });
        }

        // Update Order Status
        function updateOrderStatus(orderKey, newStatus) {
            if (confirm(`Are you sure you want to change the status to "${newStatus}"?`)) {
                db.ref('orders').child(orderKey).update({
                    status: newStatus
                }).then(() => {
                    alert('Order status updated successfully.');
                    loadOrders();
                }).catch(error => {
                    console.error(error);
                    alert('Error updating order status.');
                });
            } else {
                // Reload orders to reset the select value
                loadOrders();
            }
        }

        // Delete Order
        function deleteOrder(orderKey) {
            if (confirm('Are you sure you want to delete this order?')) {
                db.ref('orders').child(orderKey).remove().then(() => {
                    alert('Order deleted successfully.');
                    loadOrders();
                }).catch(error => {
                    console.error(error);
                    alert('Error deleting order.');
                });
            }
        }

        // Load Sales
        function loadSales() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <h2>Sales</h2>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Sale ID</th>
                            <th>Order ID</th>
                            <th>Amount ($)</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table-body">
                        <!-- Sales Will Be Loaded Here -->
                    </tbody>
                </table>
                <h3 id="total-sales-display">Total Sales: $0.00</h3>
            `;

            let totalSales = 0;

            db.ref('sales').once('value').then(snapshot => {
                const sales = snapshot.val() || {};
                const tableBody = document.getElementById('sales-table-body');
                tableBody.innerHTML = ''; // Clear existing data

                for (const key in sales) {
                    const sale = sales[key];
                    if (sale && franchises.some(franchise => String(franchise.franchiseId) === String(sale.franchiseId))) {
                        const row = `
                            <tr>
                                <td>${sale.saleId}</td>
                                <td>${sale.orderId}</td>
                                <td>${parseFloat(sale.amount).toFixed(2)}</td>
                            </tr>
                        `;
                        tableBody.insertAdjacentHTML('beforeend', row);
                        totalSales += parseFloat(sale.amount);
                    }
                }

                document.getElementById('total-sales-display').innerText = `Total Sales: $${totalSales.toFixed(2)}`;
            }).catch(error => {
                console.error(error);
                alert('Error fetching sales data.');
            });
        }

    </script>
</body>
</html>
